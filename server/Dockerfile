FROM golang:1.22 AS build

# Accept build arguments
ARG CACHE_CONN
ARG DB_CONN
ARG EMAIL_ADDRESS
ARG EMAIL_HOST
ARG EMAIL_PASSWORD
ARG EMAIL_PORT
ARG EMAIL_USERNAME
ARG JWT_SECRET
ARG MAGICLINK_BASE
ARG PORT
ARG PRODUCTION
ARG SERVER
ARG SERVICE_HOSTNAME

# Use the build arguments
ENV CACHE_CONN=$CACHE_CONN
ENV DB_CONN=$DB_CONN
ENV EMAIL_ADDRESS=$EMAIL_ADDRESS
ENV EMAIL_HOST=$EMAIL_HOST
ENV EMAIL_PASSWORD=$EMAIL_PASSWORD
ENV EMAIL_PORT=$EMAIL_PORT
ENV EMAIL_USERNAME=$EMAIL_USERNAME
ENV JWT_SECRET=$JWT_SECRET
ENV MAGICLINK_BASE=$MAGICLINK_BASE
ENV PORT=$PORT
ENV PRODUCTION=$PRODUCTION
ENV SERVER=$SERVER
ENV SERVICE_HOSTNAME=$SERVICE_HOSTNAME

# build steps
WORKDIR /app
COPY . .
RUN go build -o main .


# final stages
FROM alpine:latest
WORKDIR /root/
COPY --from=builder /app/main .
CMD ["./main"]

EXPOSE 8080
