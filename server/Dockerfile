#build stage
FROM golang:1.22-alpine AS builder

ARG CACHE_CONN
ARG DB_CONN
ARG EMAIL_ADDRESS
ARG EMAIL_HOST
ARG EMAIL_PASSWORD
ARG EMAIL_PORT
ARG EMAIL_USERNAME
ARG JWT_SECRET
ARG MAGICLINK_BASE
ARG PORT
ARG PRODUCTION
ARG SERVER
ARG SERVICE_HOSTNAME

ENV CACHE_CONN $CACHE_CONN
ENV DB_CONN $DB_CONN
ENV EMAIL_ADDRESS $EMAIL_ADDRESS
ENV EMAIL_HOST $EMAIL_HOST
ENV EMAIL_PASSWORD $EMAIL_PASSWORD
ENV EMAIL_PORT $EMAIL_PORT
ENV EMAIL_USERNAME $EMAIL_USERNAME
ENV JWT_SECRET $JWT_SECRET
ENV MAGICLINK_BASE $MAGICLINK_BASE
ENV PORT $PORT
ENV PRODUCTION $PRODUCTION
ENV SERVER $SERVER
ENV SERVICE_HOSTNAME $SERVICE_HOSTNAME

RUN apk add --no-cache git

WORKDIR /app

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -o main .


# final stage
FROM alpine:latest

RUN apk add --no-cache ca-certificates

WORKDIR /root/

COPY --from=builder /app/main .

EXPOSE 8080

CMD ["./main"]

